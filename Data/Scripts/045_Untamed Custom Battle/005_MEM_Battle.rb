MEGA_EVO_STATS = {
  GYARADOS: { item: :GYARADOSITE, atkmul: 1.240, defmul: 1.380, spemul: 1.000, spamul: 1.167, spdmul: 1.300 },
  LEDIAN: { item: :LEDINITE, atkmul: 1.625, defmul: 1.000, spemul: 1.471, spamul: 0.778, spdmul: 1.200 },
  XATU: { item: :XATUNITE, atkmul: 1.187, defmul: 1.014, spemul: 1.011, spamul: 1.295, spdmul: 1.800 },
  AMPHAROS: { item: :AMPHAROSITE, atkmul: 1.000, defmul: 1.352, spemul: 0.909, spamul: 1.434, spdmul: 1.333 },
  MAGCARGO: { item: :MAGCARGOITE, atkmul: 1.200, defmul: 1.333, spemul: 1.667, spamul: 1.111, spdmul: 1.250 },
  SKARMORY: { item: :SKARMORITE, atkmul: 1.500, defmul: 1.143, spemul: 1.143, spamul: 1.500, spdmul: 1.143 },
  MAWILE: { item: :MAWILITE, atkmul: 1.235, defmul: 1.471, spemul: 1.000, spamul: 1.000, spdmul: 1.727 },
  SABLEYE: { item: :SABLEYEITE, atkmul: 1.000, defmul: 1.800, spemul: 0.400, spamul: 1.154, spdmul: 1.923 },
  BANETTE: { item: :BANETTITE, atkmul: 1.261, defmul: 1.267, spemul: 1.000, spamul: 1.241, spdmul: 1.411 },
  GLALIE: { item: :GLALITITE, atkmul: 1.500, defmul: 1.000, spemul: 1.250, spamul: 1.500, spdmul: 1.000 },
  FLYGON: { item: :FLYGONITE, atkmul: 1.300, defmul: 1.000, spemul: 1.200, spamul: 1.625, spdmul: 1.000 },
  CACTURNE: { item: :CACTURNITE, atkmul: 1.174, defmul: 1.667, spemul: 1.000, spamul: 1.261, spdmul: 1.167 },
  MILOTIC: { item: :MILOTITE, atkmul: 1.417, defmul: 1.215, spemul: 1.012, spamul: 1.260, spdmul: 1.248 },
  CHIMECHO: { item: :CHIMECHITE, atkmul: 1.000, defmul: 1.250, spemul: 1.000, spamul: 1.211, spdmul: 1.667 },
  PORYGONZ: { item: :PORYGONZITE, atkmul: 1.600, defmul: 1.143, spemul: 1.133, spamul: 1.148, spdmul: 1.133 },
  BEHEEYEM: { item: :BEHEEYEMITE, atkmul: 1.400, defmul: 1.000, spemul: 1.750, spamul: 1.080, spdmul: 1.316 },
  GOLURK: { item: :GOLURKITE, atkmul: 1.161, defmul: 1.313, spemul: 1.818, spamul: 1.182, spdmul: 1.000 },
  HAWLUCHA: { item: :HAWLUCHITE, atkmul: 1.435, defmul: 1.267, spemul: 1.000, spamul: 1.270, spdmul: 1.317 },
  TREVENANT: { item: :TREVENANTITE, atkmul: 1.167, defmul: 1.305, spemul: 0.821, spamul: 1.385, spdmul: 1.488 },
  DIANCIE: { item: :DIANCITE, atkmul: 1.222, defmul: 1.154, spemul: 1.364, spamul: 1.222, spdmul: 1.154 },
  FROSMOTH: { item: :FROSMOTHITE, atkmul: 1.000, defmul: 1.333, spemul: 1.308, spamul: 1.080, spdmul: 1.556 },

  CAMERUPT: { item: :CAMERUPTITE, atkmul: 1.200, defmul: 1.429, spemul: 0.500, spamul: 1.381, spdmul: 1.400 },
  ABOMASNOW: { item: :ABOMASITE, atkmul: 1.435, defmul: 1.400, spemul: 0.500, spamul: 1.435, spdmul: 1.235 },

  ATELANGLER: { item: :ATELANGLITE, atkmul: 1.538, defmul: 1.325, spemul: 1.079, spamul: 1.185, spdmul: 1.147 },
  BEAKRAFT: { item: :BEAKRAFTITE, 
              male: { atkmul: 1.211, defmul: 1.250, spemul: 1.051, spamul: 1.520, spdmul: 1.333 }, 
              female: { atkmul: 1.167, defmul: 1.105, spemul: 1.051, spamul: 2.000, spdmul: 1.267 } },
  CHIXULOB: { item: :CHIXULITE, atkmul: 1.268, defmul: 1.882, spemul: 1.147, spamul: 0.927, spdmul: 1.392 },
  FRIZZARD: { item: :FRIZZARDITE, atkmul: 1.231, defmul: 1.143, spemul: 1.056, spamul: 1.381, spdmul: 1.330 },
  GOHILA: { item: :GOHILITE, atkmul: 1.304, defmul: 1.029, spemul: 1.020, spamul: 1.500, spdmul: 1.493 },
  LAGUNA: { item: :LAGUNITE, atkmul: 1.200, defmul: 1.100, spemul: 1.288, spamul: 1.571, spdmul: 1.182 },
  LUPACABRA: { item: :LUPACABRITE, atkmul: 1.286, defmul: 1.588, spemul: 1.182, spamul: 1.000, spdmul: 1.143 },
  M_ROSERADE: { item: :M_ROSERADITE, atkmul: 1.462, defmul: 1.383, spemul: 1.022, spamul: 1.190, spdmul: 1.200 },
  NOCTAVISPA: { item: :NOCTAVISPITE, atkmul: 1.538, defmul: 1.052, spemul: 1.149, spamul: 1.329, spdmul: 1.190 },
  ROADRAPTOR: { item: :ROADRAPTORITE, atkmul: 1.372, defmul: 1.385, spemul: 1.000, spamul: 1.625, spdmul: 1.000 },
  SPECTERZAL: { item: :SPECTERZITE, atkmul: 1.112, defmul: 2.000, spemul: 1.000, spamul: 1.118, spdmul: 1.154 },
  SUCHOBILE: { item: :SUCHOBITE, atkmul: 1.317, defmul: 1.583, spemul: 0.774, spamul: 1.165, spdmul: 1.314 },
  ZARCOIL: { item: :ZARCOILITE, atkmul: 1.227, defmul: 1.290, spemul: 1.282, spamul: 1.217, spdmul: 1.133 },
  ZOLUPINE: { item: :ZOLUPINEITE, atkmul: 1.118, defmul: 1.167, spemul: 1.000, spamul: 1.421, spdmul: 1.381 }
}

MEGA_EVO_TYPES = {
  GYARADOS: { item: :GYARADOSITE, typeadd: :DARK },
  LEDIAN: { item: :LEDINITE, typeadd: :FIGHTING, typeremove: :FLYING },
  XATU: { item: :XATUNITE, typeadd: :FIRE, typeremove: :FLYING },
  AMPHAROS: { item: :AMPHAROSITE, typeadd: :DRAGON },
  MAGCARGO: { item: :MAGCARGOITE, typeadd: :STEEL, typeremove: :ROCK },
  FLYGON: { item: :FLYGONITE, typeadd: :BUG },
  MILOTIC: { item: :MILOTITE, typeadd: :FAIRY },
  CHIMECHO: { item: :CHIMECHITE, typeadd: :STEEL },
  PORYGONZ: { item: :PORYGONZITE, typeadd: :QMARKS, typeremove: :NORMAL },
  BEHEEYEM: { item: :BEHEEYEMITE, typeadd: :ELECTRIC },
  GOLURK: { item: :GOLURKITE, typeadd: :FLYING },
  FROSMOTH: { item: :FROSMOTHITE, typeadd: :FIRE },
  BEAKRAFT: { item: :BEAKRAFTITE, typeadd: :ELECTRIC, typeremove: :FLYING },
  GOHILA: { item: :GOHILITE, typeadd: :ELECTRIC },
  LAGUNA: { item: :LAGUNITE, typeadd: :ICE, typeremove: :NORMAL },
  LUPACABRA: { item: :LUPACABRITE, typeadd: :FIGHTING },
  ROADRAPTOR: { item: :ROADRAPTORITE, typeadd: :GROUND, typeremove: :FLYING },
  ZOLUPINE: { item: :ZOLUPINEITE, typeadd: :GHOST, typeremove: :DARK }
}

MEGA_EVO_MOVESET = {
  :PORYGONZ => [:CONVERSION, :HARDDRIVECRASH],
  :CACTURNE => [:BULLETSEED, :SPLINTERSHOT],
  :GOLURK   => [:SHADOWBALL, :AEROBLAST]
}

class Pokemon
  attr_accessor :megaevoMutation
  ################################################################################
  # Mega Evolution Mutation
  ################################################################################ 
  # Enables Mega Evolution Mutation.
  @megaevoMutation = false
  def enableMegaEvoMutation
    @megaevoMutation = true
  end  
  # Disables Mega Evolution Mutation.
  def disableMegaEvoMutation
    @megaevoMutation = false
  end    

  # Toggles Mega Evolution Mutation.
  def toggleMegaEvoMutation
    if !@megaevoMutation
      @megaevoMutation = true
    else  
      @megaevoMutation = false
    end  
  end     
  
  def hasMegaEvoMutation?
    if @megaevoMutation==true || Settings::GLOBAL_MUTATION==true
      return true 
    end  
  end
end

class Battle::Battler
  def hasMegaEvoMutation?
    return (@pokemon) ? @pokemon.hasMegaEvoMutation? : false
  end
  def willmega
    return @pokemon.willmega
  end
end
class Battle::FakeBattler
  def hasMegaEvoMutation?
    return (@pokemon) ? @pokemon.hasMegaEvoMutation? : false
  end
  def willmega
    return @pokemon.willmega
  end
end

class Battle
  def pbGetMegaEvolutionMove(battler)
    return if !MEGA_EVO_MOVESET.key?(battler.species)
    return if !$player.difficulty_mode?("chaos")
    oldmove = MEGA_EVO_MOVESET[battler.species][0]
    newmove = MEGA_EVO_MOVESET[battler.species][1]
    return if !oldmove || !newmove
    if battler.mega?
      moveslot = 0
      battler.moves.each_with_index do |m, i|
        battler.base_moves.push(battler.moves[i])
        if m.id == oldmove
          battler.moves[i] = Battle::Move.from_pokemon_move(battler.battle, Pokemon::Move.new(newmove))
          battler.moves[i].pp       = 5
          battler.moves[i].total_pp = 5
        end
      end
    end
  end

  def pbCanMegaEvolve?(idxBattler)
    return false if $game_switches[Settings::NO_MEGA_EVOLUTION]
    return true if $DEBUG && Input.press?(Input::CTRL)
    return false if @battlers[idxBattler].effects[PBEffects::SkyDrop] >= 0
    #~ return false if !pbHasMegaRing?(idxBattler)
    # MEM stuff #by low
    if !@battlers[idxBattler].hasMegaEvoMutation?
      return false if !@battlers[idxBattler].hasMega?
      return false if @battlers[idxBattler].mega?
      return false if @battlers[idxBattler].wild?
      side  = @battlers[idxBattler].idxOwnSide
      owner = pbGetOwnerIndexFromBattlerIndex(idxBattler)
      return @megaEvolution[side][owner] == -1
    end
    ######################
    return true
  end

  def pbMegaEvolve(idxBattler)
    battler = @battlers[idxBattler]
    return if !battler || !battler.pokemon
    return if !battler.hasMega? || battler.mega?
    triggers = ["mega", "mega" + battler.species.to_s]
    battler.pokemon.types.each { |t| triggers.push("mega" + t.to_s) }
    @scene.pbDeluxeTriggers(idxBattler, nil, triggers)
    $stats.mega_evolution_count += 1 if battler.pbOwnedByPlayer?
    old_ability = battler.ability_id
    if battler.hasActiveAbility?(:ILLUSION)
      Battle::AbilityEffects.triggerOnBeingHit(battler.ability, nil, battler, nil, self)
    end
    # MEM stuff #by low
    if battler.wild? || battler.hasMegaEvoMutation?
    ###################
      case battler.pokemon.megaMessage
      when 1
        pbDisplay(_INTL("{1}'s fervent wish has reached {2}!", trainerName, battler.pbThis))
      else
        pbDisplay(_INTL("{1} radiates with Mega energy!", battler.pbThis))
      end
    else
      trainerName = pbGetOwnerName(idxBattler)
      case battler.pokemon.megaMessage
      when 1
        pbDisplay(_INTL("{1}'s fervent wish has reached {2}!", trainerName, battler.pbThis))
      when 2 # pory-z
        pbDisplay(_INTL("{1}'s corrupted code is modifying {2}!", trainerName, battler.pbThis))
      when 3 # KISAMAAAAAAAAAAAAAAA
        pbDisplay(_INTL("{1}'s bell has resonated with {2}!", trainerName, battler.pbThis))
      else
        pbDisplay(_INTL("{1}'s {2} is reacting to {3}'s {4}!",
                        battler.pbThis, battler.itemName, trainerName, pbGetMegaRingName(idxBattler)))
      end
    end
    if @scene.pbCommonAnimationExists?("MegaEvolution")
      pbCommonAnimation("MegaEvolution", battler)
      battler.pokemon.makeMega
      battler.form = battler.pokemon.form
      @scene.pbChangePokemon(battler, battler.pokemon)
      pbCommonAnimation("MegaEvolution2", battler)
    else 
      if Settings::SHOW_MEGA_ANIM && $PokemonSystem.battlescene == 0
        @scene.pbShowMegaEvolution(idxBattler)
        battler.pokemon.makeMega
        battler.form = battler.pokemon.form
        @scene.pbChangePokemon(battler, battler.pokemon)
      else
        @scene.pbRevertBattlerStart(idxBattler)
        battler.pokemon.makeMega
        battler.form = battler.pokemon.form
        @scene.pbChangePokemon(battler, battler.pokemon)
        @scene.pbRevertBattlerEnd
      end
    end
    battler.pokemon.willmega = false
    battler.pbUpdate(true)
    @scene.pbRefreshOne(idxBattler)
    megaName = battler.pokemon.megaName
    megaName = _INTL("Mega {1}", battler.pokemon.speciesName) if nil_or_empty?(megaName)
    pbDisplay(_INTL("{1} has Mega Evolved into {2}!", battler.pbThis, megaName))
    unless battler.hasMegaEvoMutation?
      side  = battler.idxOwnSide
      owner = pbGetOwnerIndexFromBattlerIndex(idxBattler)
      @megaEvolution[side][owner] = -2
    end
    if battler.isSpecies?(:GENGAR) && battler.mega?
      battler.effects[PBEffects::Telekinesis] = 0
    end
    battler.pbOnLosingAbility(old_ability)
    battler.pbTriggerAbilityOnGainingIt
    pbCalculatePriority(false, [idxBattler]) if !$game_switches[OLDSCHOOLBATTLE]
    
    #increment achievement
    if battler.mega? && pbOwnedByPlayer?(battler)
      Achievements.incrementProgress("MEGA_EVOLUTIONS",1)
    end
    
  end
end

class Pokemon
  def getMegaForm
    ret = 0
    GameData::Species.each do |data|
      next if data.species != @species || data.unmega_form != form_simple
      # MEM stuff #by low
      if data.mega_stone && (hasItem?(data.mega_stone) || hasMegaEvoMutation?)
        ret = data.form
        ret = (self.form + 2) if self.species == :BEAKRAFT
        break
      elsif data.mega_move && (hasMove?(data.mega_move) || hasMegaEvoMutation?)
        ret = data.form
        break
      end
      ###################
    end
    return ret   # form number, or 0 if no accessible Mega form
  end
end